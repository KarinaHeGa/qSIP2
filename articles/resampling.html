<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Resampling • qSIP2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Resampling">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">qSIP2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.17.4.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/qSIP_workflow.html">Standard qSIP EAF Workflow</a></li>
    <li><a class="dropdown-item" href="../articles/filtering.html">Filtering Features</a></li>
    <li><a class="dropdown-item" href="../articles/resampling.html">Resampling</a></li>
    <li><a class="dropdown-item" href="../articles/EAF.html">EAF Calculations</a></li>
    <li><a class="dropdown-item" href="../articles/growth.html">Growth Workflow</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jeffkimbrel/qSIP2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Resampling</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jeffkimbrel/qSIP2/blob/master/vignettes/resampling.Rmd" class="external-link"><code>vignettes/resampling.Rmd</code></a></small>
      <div class="d-none name"><code>resampling.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jeffkimbrel/qSIP2" class="external-link">qSIP2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"qSIP2"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] '0.17.4.9000'</span></span></code></pre></div>
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>In <code>qSIP2</code> we use <em>resampling</em> of the weighted
average densities (WADs) to obtain the confidence intervals of the WADs
<em>within</em> replicates of a type (unlabeled vs labeled) as well as
in the shift of average WADs <em>between</em> types. The resampling is a
simple bootstrap procedure where the source WADs for each
<code>feature_id</code> are sampled with replacement
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
times.</p>
</div>
<div class="section level2">
<h2 id="resampling-in-r">Resampling in R<a class="anchor" aria-label="anchor" href="#resampling-in-r"></a>
</h2>
<p>Let’s assume a WAD dataset of 4 sources labeled <em>A</em> -
<em>D</em>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">WADs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"A"</span> <span class="op">=</span> <span class="fl">1.679</span>, <span class="st">"B"</span> <span class="op">=</span> <span class="fl">1.691</span>, <span class="st">"C"</span> <span class="op">=</span> <span class="fl">1.692</span>, <span class="st">"D"</span> <span class="op">=</span> <span class="fl">1.703</span><span class="op">)</span></span></code></pre></div>
<p>Sampling these 4 values with replacement will lead to some duplicates
and some values missing. For example, below we see that <em>B</em> was
sampled twice (denoted with the “.1”) and <em>C</em> was not sampled at
all.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">WADs</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">B</th>
<th align="right">D</th>
<th align="right">A</th>
<th align="right">B.1</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">1.691</td>
<td align="right">1.703</td>
<td align="right">1.679</td>
<td align="right">1.691</td>
</tr></tbody>
</table>
<p>We can wrap it in a <code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">purrr::map()</a></code> function to sample
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
times. The output is a bit messy because each “.1” column name is shown,
but there are still only 4 values per row after excluding the
<code>NA</code> values.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, </span>
<span>              <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">WADs</span>, </span>
<span>                      replace <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                      size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">B</th>
<th align="right">D</th>
<th align="right">A</th>
<th align="right">D.1</th>
<th align="right">B.1</th>
<th align="right">C</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1.691</td>
<td align="right">1.703</td>
<td align="right">1.679</td>
<td align="right">1.703</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">1.691</td>
<td align="right">1.703</td>
<td align="right">1.679</td>
<td align="right">NA</td>
<td align="right">1.691</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">NA</td>
<td align="right">1.703</td>
<td align="right">1.679</td>
<td align="right">1.703</td>
<td align="right">NA</td>
<td align="right">1.692</td>
</tr>
<tr class="even">
<td align="right">1.691</td>
<td align="right">1.703</td>
<td align="right">1.679</td>
<td align="right">NA</td>
<td align="right">1.691</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">1.691</td>
<td align="right">1.703</td>
<td align="right">1.679</td>
<td align="right">1.703</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="qsip2-resampling">qSIP2 resampling<a class="anchor" aria-label="anchor" href="#qsip2-resampling"></a>
</h2>
<p>The <code>qSIP2</code> package has a function called
<code><a href="../reference/run_resampling.html">run_resampling()</a></code> that will perform the resampling procedure
on a filtered <code>qSIP_data</code> object. This object must first be
filtered with the <code><a href="../reference/run_feature_filter.html">run_feature_filter()</a></code> function, and we’ll
come back to how this filtering affects the resampling in a bit.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_feature_filter.html">run_feature_filter</a></span><span class="op">(</span><span class="va">example_qsip_object</span>,</span>
<span>  unlabeled_source_mat_ids <span class="op">=</span> <span class="fu"><a href="../reference/get_all_by_isotope.html">get_all_by_isotope</a></span><span class="op">(</span><span class="va">example_qsip_object</span>, <span class="st">"12C"</span><span class="op">)</span>,</span>
<span>  labeled_source_mat_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S178"</span>, <span class="st">"S179"</span>, <span class="st">"S180"</span><span class="op">)</span>,</span>
<span>  min_unlabeled_sources <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  min_labeled_sources <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  min_unlabeled_fractions <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  min_labeled_fractions <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># running with quiet = TRUE to suppress messages</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_resampling.html">run_resampling</a></span><span class="op">(</span><span class="va">q</span>,</span>
<span>  resamples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  with_seed <span class="op">=</span> <span class="fl">19</span>,</span>
<span>  progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Setting <code>resamples = 1000</code> will give 1000 resamplings for
each feature. The resampling is not a deterministic procedure, and so
the use of a seed is recommended using the <code>with_seed</code>
argument.</p>
<div class="section level3">
<h3 id="under-the-hood">Under the hood<a class="anchor" aria-label="anchor" href="#under-the-hood"></a>
</h3>
<p>Internally, the <code>qSIP2</code> code has a function that is called
that makes the resampling output a bit more tidy. It does this by
removing the original names and prepending them with the <em>type</em>.
So, if the data was the “labeled” type, then resampled values will be in
columns <em>labeled_1</em>, <em>labeled_2</em>, etc. It will also keep
the data tidy by adding additional columns that are useful. This
function is not called directly by the user, so it is shown here just as
an example of the resampling procedure.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, \<span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="../reference/calculate_resampled_wads.html">calculate_resampled_wads</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">WADs</span>, <span class="st">"labeled"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Example of resampling 4 WAD values 5 times</caption>
<colgroup>
<col width="16%">
<col width="11%">
<col width="13%">
<col width="14%">
<col width="14%">
<col width="14%">
<col width="14%">
</colgroup>
<thead><tr class="header">
<th align="left">feature_id</th>
<th align="left">type</th>
<th align="right">resample</th>
<th align="right">labeled_1</th>
<th align="right">labeled_2</th>
<th align="right">labeled_3</th>
<th align="right">labeled_4</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="left">labeled</td>
<td align="right">1</td>
<td align="right">1.692</td>
<td align="right">1.692</td>
<td align="right">1.692</td>
<td align="right">1.679</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="left">labeled</td>
<td align="right">2</td>
<td align="right">1.692</td>
<td align="right">1.692</td>
<td align="right">1.691</td>
<td align="right">1.692</td>
</tr>
<tr class="odd">
<td align="left">1</td>
<td align="left">labeled</td>
<td align="right">3</td>
<td align="right">1.692</td>
<td align="right">1.679</td>
<td align="right">1.692</td>
<td align="right">1.691</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="left">labeled</td>
<td align="right">4</td>
<td align="right">1.691</td>
<td align="right">1.692</td>
<td align="right">1.692</td>
<td align="right">1.691</td>
</tr>
<tr class="odd">
<td align="left">1</td>
<td align="left">labeled</td>
<td align="right">5</td>
<td align="right">1.691</td>
<td align="right">1.691</td>
<td align="right">1.692</td>
<td align="right">1.691</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="inspect-resample-results">Inspect resample results<a class="anchor" aria-label="anchor" href="#inspect-resample-results"></a>
</h2>
<p>The resampling results are stored in the <code>qSIP_data</code>
object in the <code>@resamples</code> slot, but they are not necessarily
intended to be worked with directly. Instead, the <code>qSIP_data</code>
object has helper functions like <code><a href="../reference/n_resamples.html">n_resamples()</a></code> and
<code><a href="../reference/resample_seed.html">resample_seed()</a></code> that will return the number of resamples
that were performed and the seed that was used, respectively.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/n_resamples.html">n_resamples</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1000</span></span>
<span><span class="fu"><a href="../reference/resample_seed.html">resample_seed</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 19</span></span></code></pre></div>
<div class="section level3">
<h3 id="dataframe-of-resampled-wads">Dataframe of resampled WADs<a class="anchor" aria-label="anchor" href="#dataframe-of-resampled-wads"></a>
</h3>
<p>If you want the data itself, you can access it with the
<code><a href="../reference/get_resample_data.html">get_resample_data()</a></code> function and appropriate arguments.
Note, if you set <code>pivot = TRUE</code> the dataframe can be quite
large and take a while to assemble/display.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_resample_data.html">get_resample_data</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 74,000 × 13</span></span></span>
<span><span class="co">#&gt;    feature_id resample unlabeled_1 unlabeled_2 unlabeled_3 unlabeled_4</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> ASV_1             1        1.70        1.70        1.71        1.70</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> ASV_10            1        1.71        1.71        1.71        1.72</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> ASV_104           1        1.71        1.71        1.71        1.71</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> ASV_108           1        1.72        1.71        1.72        1.72</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> ASV_11            1        1.72        1.71        1.71        1.72</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> ASV_112           1        1.71        1.71        1.71        1.71</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> ASV_114           1        1.71        1.71        1.72        1.72</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> ASV_119           1        1.72        1.71        1.71        1.72</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> ASV_12            1        1.71        1.71        1.71        1.72</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> ASV_13            1        1.71        1.71        1.71        1.71</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 73,990 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 7 more variables: unlabeled_5 &lt;dbl&gt;, unlabeled_6 &lt;dbl&gt;, unlabeled_7 &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   unlabeled_8 &lt;dbl&gt;, labeled_1 &lt;dbl&gt;, labeled_2 &lt;dbl&gt;, labeled_3 &lt;dbl&gt;</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualizing-range-of-mean-resampled-wads">Visualizing range of mean resampled WADs<a class="anchor" aria-label="anchor" href="#visualizing-range-of-mean-resampled-wads"></a>
</h3>
<p>Rather than seeing all of the resampled data itself, you are often
only interested in the range of the mean WAD values for each resampling
iteration. You can leave the <code>feature_id</code> argument empty to
see all of the features, or you can specify a single feature or a vector
of features. Here, I will select 3 random feature_ids to show.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">random_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_feature_ids.html">get_feature_ids</a></span><span class="op">(</span><span class="va">q</span>, filtered <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_feature_resamplings.html">plot_feature_resamplings</a></span><span class="op">(</span><span class="va">q</span>, </span>
<span>                         feature_id <span class="op">=</span> <span class="va">random_features</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: No shared levels found between `names(values)` of the manual scale and the</span></span>
<span><span class="co">#&gt; data's <span style="color: #00BB00;">colour</span> values.</span></span></code></pre></div>
<p><img src="resampling_files/figure-html/unnamed-chunk-13-1.png" width="768"></p>
<p>Additional arguments can be called to add the confidence intervals
(as bars or lines) or with a different confidence limit (default =
<code>0.9</code>).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_feature_resamplings.html">plot_feature_resamplings</a></span><span class="op">(</span><span class="va">q</span>, </span>
<span>                         feature_id <span class="op">=</span> <span class="va">random_features</span>,</span>
<span>                         interval <span class="op">=</span> <span class="st">"bar"</span>,</span>
<span>                         confidence <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"With confidence interval bars"</span><span class="op">)</span></span></code></pre></div>
<p><img src="resampling_files/figure-html/unnamed-chunk-14-1.png" width="768"></p>
</div>
</div>
<div class="section level2">
<h2 id="when-resampling-goes-wrong">When resampling goes wrong<a class="anchor" aria-label="anchor" href="#when-resampling-goes-wrong"></a>
</h2>
<p>The resampling procedure is a simple bootstrap procedure, and so it
is not without its limitations. The most common issue is when there are
more sources than your filtering requires, and you end up with WADs that
contain <code>NA</code> values.</p>
<p>Take ASV_72 as an example, it is found in only 1 of the labeled
sources (S178) above the fraction threshold, so it was removed from the
previous filtering step. But, if your filtering requirements were less
strict as before (e.g. by setting <code>min_labeled_sources = 1</code>),
then this feature could make it through the filtering.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_feature_filter.html">run_feature_filter</a></span><span class="op">(</span><span class="va">example_qsip_object</span>,</span>
<span>  unlabeled_source_mat_ids <span class="op">=</span> <span class="fu"><a href="../reference/get_all_by_isotope.html">get_all_by_isotope</a></span><span class="op">(</span><span class="va">example_qsip_object</span>, <span class="st">"12C"</span><span class="op">)</span>,</span>
<span>  labeled_source_mat_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S178"</span>, <span class="st">"S179"</span>, <span class="st">"S180"</span><span class="op">)</span>,</span>
<span>  min_unlabeled_sources <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  min_labeled_sources <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  min_unlabeled_fractions <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  min_labeled_fractions <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span> <span class="co"># running with quiet = TRUE to suppress messages</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">feature_id</th>
<th align="left">source_mat_id</th>
<th align="right">WAD</th>
<th align="right">n_fractions</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">ASV_72</td>
<td align="left">S150</td>
<td align="right">1.713317</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">ASV_72</td>
<td align="left">S152</td>
<td align="right">1.764545</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">ASV_72</td>
<td align="left">S149</td>
<td align="right">1.741933</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">ASV_72</td>
<td align="left">S178</td>
<td align="right">1.746895</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="left">ASV_72</td>
<td align="left">S161</td>
<td align="right">1.713579</td>
<td align="right">14</td>
</tr>
<tr class="even">
<td align="left">ASV_72</td>
<td align="left">S162</td>
<td align="right">1.713647</td>
<td align="right">18</td>
</tr>
<tr class="odd">
<td align="left">ASV_72</td>
<td align="left">S163</td>
<td align="right">1.713918</td>
<td align="right">19</td>
</tr>
<tr class="even">
<td align="left">ASV_72</td>
<td align="left">S164</td>
<td align="right">1.714959</td>
<td align="right">19</td>
</tr>
</tbody>
</table>
<p>But we now get an error when running the resampling step suggesting
we increase our filtering stringency.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/run_resampling.html">run_resampling</a></span><span class="op">(</span><span class="va">q2</span>,</span>
<span>  resamples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  with_seed <span class="op">=</span> <span class="fl">19</span>,</span>
<span>  progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `purrr::map()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> In index: 10.</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Caused by error:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Something went wrong with resampling...</span></span>
<span><span class="co">#&gt; It is possible that some resampled features contained only &lt;NA&gt; WAD values leading to a failure in calculate_Z().</span></span>
<span><span class="co">#&gt; Try increasing your filtering stringency to remove features not found in most sources</span></span></code></pre></div>
<p>What is happening is that the resampling is done consistently across
all feature_ids, so although there is only one labeled source for
ASV_72, the other two sources (S179 and S180) are included in the
resampling with a WAD value of <code>NaN</code> (for “not a number”,
i.e. an numeric form of <code>NA</code>).</p>
<p>Bootstrapping a vector that is 2/3s <code>NaN</code> will fairly
often return only <code>NaN</code> values, and therefore the mean is
undefined. The previous error message above suggests increasing
<code>min_labeled_sources</code> which would remove the number of
<code>NaN</code> values passed to the resampling.</p>
<div class="section level3">
<h3 id="allow-failures">Allow failures<a class="anchor" aria-label="anchor" href="#allow-failures"></a>
</h3>
<p>Although increasing the stringency can remove the error, it will also
remove features from the dataset. If you want to keep the features
(e.g. you didn’t want <em>ASV_72</em> removed), you can set
<code>allow_failures = TRUE</code> in the <code><a href="../reference/run_resampling.html">run_resampling()</a></code>
function. This will allow the resampling to continue, but it will also
return a warning message that the resampling failed for some iterations
of some features.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_resampling.html">run_resampling</a></span><span class="op">(</span><span class="va">q2</span>,</span>
<span>  resamples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  with_seed <span class="op">=</span> <span class="fl">19</span>,</span>
<span>  allow_failures <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: NA unlabeled and NA labeled feature_ids had resampling failures. Run</span></span>
<span><span class="co">#&gt; `get_resample_counts()` or `plot_successful_resamples()` on your &lt;qsip_data&gt;</span></span>
<span><span class="co">#&gt; object to inspect.</span></span></code></pre></div>
<p>The warning message here lets us know that there were no problems
with the unlabeled resampling, but 4 features had failures for the
labeled sources. We can see which features had failures by
<code><a href="../reference/get_resample_counts.html">get_resample_counts()</a></code> and filtering for values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
less than 1000 (our number of resamples).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_resample_counts.html">get_resample_counts</a></span><span class="op">(</span><span class="va">q2</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">labeled_resamples</span> <span class="op">&lt;</span> <span class="fl">1000</span> <span class="op">|</span> <span class="va">unlabeled_resamples</span> <span class="op">&lt;</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 3</span></span></span>
<span><span class="co">#&gt;   feature_id labeled_resamples unlabeled_resamples</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ASV_149                  961                <span style="text-decoration: underline;">1</span>000</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ASV_155                  968                <span style="text-decoration: underline;">1</span>000</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ASV_161                  961                <span style="text-decoration: underline;">1</span>000</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ASV_72                   693                <span style="text-decoration: underline;">1</span>000</span></span></code></pre></div>
<p>Here, we see that indeed ASV_72 was only successful in 693 of 1000
resamplings. Statistically, you may conclude that 693 resamplings is
still robust enough to accept the conclusion. But inspecting the plot
for these 3 of these features show something strange with ASV_72 and we
may still choose to remove it from our analysis.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_feature_resamplings.html">plot_feature_resamplings</a></span><span class="op">(</span><span class="va">q2</span>, </span>
<span>                         feature_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ASV_72"</span>, <span class="st">"ASV_155"</span>, <span class="st">"ASV_161"</span><span class="op">)</span>, </span>
<span>                         intervals <span class="op">=</span> <span class="st">"bar"</span><span class="op">)</span></span></code></pre></div>
<p><img src="resampling_files/figure-html/unnamed-chunk-20-1.png" width="768"></p>
<p>We can further see the resampling successes for each feature with the
<code><a href="../reference/plot_successful_resamples.html">plot_successful_resamples()</a></code> function, and this histogram
shows that most features do have 1000 successful resamplings.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_successful_resamples.html">plot_successful_resamples</a></span><span class="op">(</span><span class="va">q2</span><span class="op">)</span></span></code></pre></div>
<p><img src="resampling_files/figure-html/unnamed-chunk-21-1.png" width="384"></p>
</div>
<div class="section level3">
<h3 id="using-success-results-for-further-filtering">Using success results for further filtering<a class="anchor" aria-label="anchor" href="#using-success-results-for-further-filtering"></a>
</h3>
<p>Suppose you want to overlay this success data on your final EAF plot
so you can decide you have enough resampling support to trust the EAF
value you obtain. This is easy to do, and you can modify the point color
based on passing a threshold. We will use a success rate of 90%
(i.e. 900 of 1000 resamples) as our threshold here.</p>
<p>Here, we can see that although most are green, ASV_72 does show up as
highly enriched and with a confidence interval clear of 0. But, the red
dot further flags it as suspect and warrants a deeper look.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">EAF</span> <span class="op">=</span> <span class="fu"><a href="../reference/run_EAF_calculations.html">run_EAF_calculations</a></span><span class="op">(</span><span class="va">q2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_EAF_values.html">plot_EAF_values</a></span><span class="op">(</span><span class="va">EAF</span>, </span>
<span>                error <span class="op">=</span> <span class="st">"ribbon"</span>,</span>
<span>                success_ratio <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span></span>
<span><span class="co">#&gt; Confidence level = 0.9</span></span></code></pre></div>
<p><img src="resampling_files/figure-html/unnamed-chunk-22-1.png" width="768"></p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>In conclusion, instead of pre-filtering your data based on the number
of sources or fractions, you can use the resampling procedure to
determine if your data is robust enough to proceed. This is especially
useful when you have a large dataset and you want to ensure that you are
not removing features that could be informative.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jeff Kimbrel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
